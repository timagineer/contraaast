const WCAG_AAA_MIN_CONTRAST=7,MAX_CONTRAST=21,STORAGE_KEY="contraaastStats";let currentStats={runs:0,highScore:0};const elements={color1:document.getElementById("color1"),color2:document.getElementById("color2"),ratio:document.getElementById("ratio"),invertBtn:document.getElementById("invert"),runBtn:document.getElementById("run"),copyBtn:document.getElementById("copy"),noOfRuns:document.getElementById("no-of-runs"),highScore:document.getElementById("high-score"),showBtn:document.getElementById("info"),closeBtn:document.getElementById("close"),dialog:document.getElementById("dialog"),titleSpan:document.querySelector("h1 span")},colorCanvas=document.createElement("canvas");colorCanvas.width=1,colorCanvas.height=1;const colorCtx=colorCanvas.getContext("2d");function loadStats(){try{const t=localStorage.getItem(STORAGE_KEY);t&&(currentStats=JSON.parse(t),updateStatsDisplay())}catch(t){console.error("Error parsing saved stats:",t),saveStats()}}function saveStats(){try{localStorage.setItem(STORAGE_KEY,JSON.stringify(currentStats)),updateStatsDisplay()}catch(t){console.error("Error saving stats:",t)}}function updateStatsDisplay(){elements.noOfRuns&&elements.highScore&&(0===currentStats.runs?elements.noOfRuns.textContent="0":elements.noOfRuns.textContent=currentStats.runs.toLocaleString(),0===currentStats.highScore?elements.highScore.textContent="##.#":currentStats.highScore>=21?elements.highScore.textContent="21!":elements.highScore.textContent=currentStats.highScore.toFixed(1))}function oklchToHex(t){try{colorCtx.fillStyle=t,colorCtx.fillRect(0,0,1,1);const e=colorCtx.getImageData(0,0,1,1).data;return`#${byteToHex(e[0])}${byteToHex(e[1])}${byteToHex(e[2])}`}catch(t){return console.error("Error converting OKLCH to hex:",t),"#000000"}}function byteToHex(t){return("0"+(t||0).toString(16)).slice(-2)}function parseOklch(t){try{const e=t.match(/oklch\(([0-9.]+)\s+([0-9.]+)\s+([0-9]+)/);return!e||e.length<4?(console.error("Could not parse OKLCH color:",t),{l:.5,c:.1,h:0}):{l:parseFloat(e[1])||.5,c:parseFloat(e[2])||.1,h:parseInt(e[3])||0}}catch(t){return console.error("Error parsing OKLCH:",t),{l:.5,c:.1,h:0}}}function formatOklch(t,e,o){const n=Math.max(0,Math.min(1,t||.5)),r=Math.max(0,e||.1),a=Math.max(0,Math.min(360,o||0));return`oklch(${n.toFixed(2)} ${r.toFixed(4)} ${a.toFixed(2)})`}function formatOklchDisplay(t){const{l:e,c:o,h:n}=parseOklch(t);return`${e.toFixed(2)} ${o.toFixed(4)} ${n.toFixed(2)}`}function calculateContrastRatio(t,e){try{const o=getLuminance(t),n=getLuminance(e);return o>n?(o+.05)/(n+.05):(n+.05)/(o+.05)}catch(t){return console.error("Error calculating contrast ratio:",t),WCAG_AAA_MIN_CONTRAST}}function getLuminance(t){try{colorCtx.fillStyle=t,colorCtx.fillRect(0,0,1,1);const[e,o,n]=colorCtx.getImageData(0,0,1,1).data,r=srgbToLinear(e/255),a=srgbToLinear(o/255);return.2126*r+.7152*a+.0722*srgbToLinear(n/255)}catch(t){return console.error("Error getting luminance:",t),.5}}function srgbToLinear(t){return(t=Math.max(0,Math.min(1,t||0)))<=.03928?t/12.92:Math.pow((t+.055)/1.055,2.4)}function initializeWithDefaultColors(){const t=window.matchMedia("(prefers-color-scheme: dark)").matches;updateUIWithColors(t?"oklch(1 0 0)":"oklch(0 0 0)",t?"oklch(0 0 0)":"oklch(1 0 0)",MAX_CONTRAST)}function updateUIWithColors(t,e,o){elements.color1&&(elements.color1.textContent=formatOklchDisplay(t)),elements.color2&&(elements.color2.textContent=formatOklchDisplay(e)),elements.ratio&&(elements.ratio.textContent=o.toFixed(1)),document.documentElement.style.setProperty("--color-1",t),document.documentElement.style.setProperty("--color-2",e)}function randomInRange(t,e){return t=Number(t)||0,e=Number(e)||1,t+Math.random()*(e-t)}function generateRandomOklchColor(){return formatOklch(randomInRange(.1,.9),randomInRange(.02,.2),Math.floor(360*Math.random()))}function generateOklchWithLightness(t){return formatOklch(t,randomInRange(.02,.2),Math.floor(360*Math.random()))}function generateDiverseColorPair(t,e,o=50){let n=null,r=0;t=Math.max(WCAG_AAA_MIN_CONTRAST,Number(t)||WCAG_AAA_MIN_CONTRAST),e=Math.min(MAX_CONTRAST,Number(e)||MAX_CONTRAST),o=Math.min(100,Math.max(10,Number(o)||50));for(let a=0;a<o;a++){const o=generateRandomOklchColor(),a=generateRandomOklchColor(),c=calculateContrastRatio(o,a);if(c>=t&&c<=e){if(Math.random()<.2)return{foreground:o,background:a,ratio:c};c>r&&(n={foreground:o,background:a,ratio:c},r=c)}}return null!==n?n:generateOptimizedContrastPair(randomInRange(t,e))}function generateOptimizedContrastPair(t){t=Math.max(WCAG_AAA_MIN_CONTRAST,Math.min(MAX_CONTRAST,Number(t)||WCAG_AAA_MIN_CONTRAST));const e=randomInRange(.1,.9),o=generateOklchWithLightness(e);let n;n=e<.5?randomInRange(.7,.95):randomInRange(.05,.3);const r=generateOklchWithLightness(n);return finetuneContrast(o,r,t,calculateContrastRatio(o,r))}function finetuneContrast(t,e,o,n){const r=parseOklch(t),a=parseOklch(e);let c=0;for(;Math.abs(n-o)>.15&&c<15&&n>=WCAG_AAA_MIN_CONTRAST&&n<=MAX_CONTRAST;){c++;let l=a;const i=Math.min(.05,Math.abs(n-o)/20);n<o?r.l<a.l?l.l=Math.min(.98,l.l+i):l.l=Math.max(.02,l.l-i):r.l<a.l?l.l=Math.max(r.l+.1,l.l-i):l.l=Math.min(r.l-.1,l.l+i);const s=formatOklch(l.l,l.c,l.h),m=calculateContrastRatio(t,s);if(!(Math.abs(m-o)<Math.abs(n-o)&&m>=WCAG_AAA_MIN_CONTRAST&&m<=MAX_CONTRAST))break;e=s,n=m}const l=calculateContrastRatio(t,e);return l<WCAG_AAA_MIN_CONTRAST||l>MAX_CONTRAST?generateFallbackContrastPair():{foreground:t,background:e,ratio:l}}function generateFallbackContrastPair(){let t,e;if(Math.random()>.5){const o=randomInRange(180,300),n=randomInRange(20,80);t=formatOklch(randomInRange(.1,.3),randomInRange(.05,.15),o),e=formatOklch(randomInRange(.7,.9),randomInRange(.05,.15),n)}else{const o=randomInRange(180,300),n=randomInRange(20,80);t=formatOklch(randomInRange(.1,.3),randomInRange(.05,.15),n),e=formatOklch(randomInRange(.7,.9),randomInRange(.05,.15),o)}const o=calculateContrastRatio(t,e);return o<WCAG_AAA_MIN_CONTRAST||o>MAX_CONTRAST?(console.warn("Fallback strategy failed to generate valid contrast, retrying..."),generateFallbackContrastPair()):{foreground:t,background:e,ratio:o}}function generateColorPair(){const t=[{min:7,max:10},{min:10,max:13},{min:13,max:17},{min:17,max:21}],e=t[Math.floor(Math.random()*t.length)];try{if(Math.random()>.5){const t=generateDiverseColorPair(e.min,e.max);return t.ratio<WCAG_AAA_MIN_CONTRAST||t.ratio>MAX_CONTRAST?(console.warn("Direct strategy failed to generate valid contrast, using fallback"),generateFallbackContrastPair()):t}{const t=generateOptimizedContrastPair(randomInRange(e.min,e.max));return t.ratio<WCAG_AAA_MIN_CONTRAST||t.ratio>MAX_CONTRAST?(console.warn("Optimized strategy failed to generate valid contrast, using fallback"),generateFallbackContrastPair()):t}}catch(t){return console.error("Error generating color pair:",t),generateFallbackContrastPair()}}function updateColorDisplay(t){t?(updateUIWithColors(t.foreground,t.background,t.ratio),currentStats.runs++,t.ratio>currentStats.highScore&&(currentStats.highScore=Math.min(t.ratio,21),t.ratio>=21?console.log("MAXIMUM SCORE: 21!!!"):console.log(`New high score: ${t.ratio.toFixed(1)}!`)),saveStats()):console.error("No color pair provided to updateColorDisplay")}function swapColors(){const t=getComputedStyle(document.documentElement).getPropertyValue("--color-1").trim(),e=getComputedStyle(document.documentElement).getPropertyValue("--color-2").trim();if(t&&e){updateUIWithColors(e,t,parseFloat(elements.ratio?.textContent||"7.0"))}else{const t=elements.color1?.textContent,e=elements.color2?.textContent;if(!t||!e)return void console.error("Could not get color values for swapping");const[o,n,r]=t.split(" "),[a,c,l]=e.split(" ");updateUIWithColors(`oklch(${a} ${c} ${l})`,`oklch(${o} ${n} ${r})`,parseFloat(elements.ratio?.textContent||"7.0"))}}function copyColorInfo(){try{const t=getComputedStyle(document.documentElement).getPropertyValue("--color-1").trim(),e=getComputedStyle(document.documentElement).getPropertyValue("--color-2").trim(),o=elements.ratio?.textContent;let n,r;if(t&&e)n=t,r=e;else{const t=elements.color1?.textContent,e=elements.color2?.textContent;if(!t||!e)return void console.error("Could not get color values for copying");const[o,a,c]=t.split(" "),[l,i,s]=e.split(" ");n=`oklch(${o} ${a} ${c})`,r=`oklch(${l} ${i} ${s})`}const a=oklchToHex(n),c=`:where(html) {\n  /* CONTRAAAST  - WCAG AAA high contrast color-pairs */\n  /* https://contraaast.timagineer.com */\n  /* Contrast Ratio: ${o} */\n  --_color-foreground: var(--color-1, ${n}, ${a});\n  --_color-background: var(--color-2, ${r}, ${oklchToHex(r)});\n}`;navigator.clipboard.writeText(c).then((()=>{const t=elements.copyBtn?.querySelector("use");if(t){const e=t.getAttribute("href");t.classList.add("c-icon-fade-out"),setTimeout((()=>{t.setAttribute("href","#icon-check"),t.classList.remove("c-icon-fade-out"),t.classList.add("c-icon-fade-in"),setTimeout((()=>{t.classList.remove("c-icon-fade-in"),t.classList.add("c-icon-fade-out"),setTimeout((()=>{t.setAttribute("href",e),t.classList.remove("c-icon-fade-out"),t.classList.add("c-icon-fade-in"),setTimeout((()=>{t.classList.remove("c-icon-fade-in")}),360)}),240)}),1e3)}),240)}})).catch((t=>{console.error("Failed to copy text: ",t)}))}catch(t){console.error("Error copying color info:",t)}}function initialize(){try{loadStats(),updateStatsDisplay(),elements.invertBtn&&elements.invertBtn.addEventListener("click",swapColors),elements.runBtn&&elements.runBtn.addEventListener("click",(()=>{updateColorDisplay(generateColorPair())})),elements.copyBtn&&elements.copyBtn.addEventListener("click",copyColorInfo),elements.showBtn&&elements.dialog&&elements.showBtn.addEventListener("click",(()=>{elements.dialog.showModal()})),elements.closeBtn&&elements.dialog&&elements.closeBtn.addEventListener("click",(()=>{elements.dialog.close()})),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",initializeWithDefaultColors),initializeWithDefaultColors()}catch(t){console.error("Error initializing application:",t)}}"interactive"===document.readyState||"complete"===document.readyState?initialize():document.addEventListener("DOMContentLoaded",initialize);
